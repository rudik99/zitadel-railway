FROM ghcr.io/zitadel/zitadel:latest

ARG ZITADEL_DATABASE_POSTGRES_HOST
ARG ZITADEL_DATABASE_POSTGRES_PORT
ARG ZITADEL_DATABASE_POSTGRES_DATABASE
ARG ZITADEL_DATABASE_POSTGRES_USER_USERNAME
ARG ZITADEL_DATABASE_POSTGRES_USER_PASSWORD
ARG ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME
ARG ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD
ARG ZITADEL_EXTERNALSECURE
ARG ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE
ARG ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE
ARG ZITADEL_EXTERNALDOMAIN
ARG ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME
ARG ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD
ARG ZITADEL_FIRSTINSTANCE_ORG_NAME
ARG ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL_ADDRESS
ARG ZITADEL_MASTERKEY
ARG ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED
ARG ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME
ARG ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME
ARG ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE
ARG ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED
ARG ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI
ARG ZITADEL_OIDC_DEFAULTLOGINURLV2
ARG ZITADEL_OIDC_DEFAULTLOGOUTURLV2
ARG ZITADEL_OIDC_DEFAULTERRORURLV2

ENV ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE=${ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE}
ENV ZITADEL_DATABASE_POSTGRES_HOST=${ZITADEL_DATABASE_POSTGRES_HOST}
ENV ZITADEL_DATABASE_POSTGRES_PORT=${ZITADEL_DATABASE_POSTGRES_PORT}
ENV ZITADEL_DATABASE_POSTGRES_DATABASE=${ZITADEL_DATABASE_POSTGRES_DATABASE}
ENV ZITADEL_DATABASE_POSTGRES_USER_USERNAME=${ZITADEL_DATABASE_POSTGRES_USER_USERNAME}
ENV ZITADEL_DATABASE_POSTGRES_USER_PASSWORD=${ZITADEL_DATABASE_POSTGRES_USER_PASSWORD}
ENV ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME=${ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME}
ENV ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD=${ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD}
ENV ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE=${ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE}
ENV ZITADEL_EXTERNALSECURE=${ZITADEL_EXTERNALSECURE}
ENV ZITADEL_EXTERNALDOMAIN=${ZITADEL_EXTERNALDOMAIN}
ENV ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME}
ENV ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD}
ENV ZITADEL_FIRSTINSTANCE_ORG_NAME=${ZITADEL_FIRSTINSTANCE_ORG_NAME}
ENV ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL_ADDRESS=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL_ADDRESS}
ENV ZITADEL_MASTERKEY=${ZITADEL_MASTERKEY}
ENV ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED=${ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED}
ENV ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME=${ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME}
ENV ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME=${ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME}
ENV ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE=${ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE}
ENV ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED=${ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED}
ENV ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI=${ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI}
ENV ZITADEL_OIDC_DEFAULTLOGINURLV2=${ZITADEL_OIDC_DEFAULTLOGOUTURLV2}
ENV ZITADEL_OIDC_DEFAULTLOGOUTURLV2=${ZITADEL_OIDC_DEFAULTLOGOUTURLV2}
ENV ZITADEL_OIDC_DEFAULTERRORURLV2=${ZITADEL_OIDC_DEFAULTERRORURLV2}

# Set PAT file path to a writable location
ENV ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH="/tmp/pat/login-client.pat"

EXPOSE 8080

# Create wrapper script inline to handle PAT file creation
CMD sh -c 'mkdir -p /tmp/pat && touch /tmp/pat/login-client.pat && exec zitadel start-from-init --masterkeyFromEnv --tlsMode external'